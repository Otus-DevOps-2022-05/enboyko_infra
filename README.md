# enboyko_infra
enboyko Infra repository


# HOMEWORK #3:

1. Command for the one-line connection (NOT with an alias):
ssh -i ~/.ssh/id_rsa -A admin@51.250.75.175 ssh -tt admin@10.128.0.20

2. Configuration of ~/.ssh/config for the connection with an alias with the command ssh someinternalhost :
Host bastion
        HostName 51.250.75.175
        User admin
Host someinternalhost
        HostName 10.128.0.20
        User admin
        ProxyJump bastion

3. Configuration of bastion and someinternalhost:
bastion_IP = 51.250.75.175
someinternalhost_IP = 10.128.0.20


# HOMEWORK #4:

There's config.yaml for cloud instance configuration.

Below is the command for the instance creation and aplllications start:

$ ./startup.sh

testapp_IP = 51.250.8.189
testapp_port = 9292


# HOMEWORK #5:

1. Установил и настроил packer
2. Создал сервисный аккаунт для Packer в Yandex.Cloud
3. Делегировал права сервисному аккаунту для Packer
4. Создал Service account key file
5. Создал файл-шаблон - образ Packer
6. Создал в Yandex Cloud виртуальную машину из ранее созданного образа Packer
7. Установил приложение и проверил его работу
8. Параметризировал шаблон Packer, изменив опции Builder'а
9. (Задание со *) Автоматизировал создание ВМ с помощью скрипта create-reddit-vm.sh


# HOMEWORK #6:

1. Установил Terraform на локальный хост
2. Создал файл .gitignore
3. Создал сервисный аккаунт для Terraform
4. Создал главный конфигурационный файл Terraform'а main.tf
5. Добавил провижинеров в main.tf, а также добавил необходимые файлы для деплоя приложения на будущем инстансе
6. Задал input- и output- переменные в соответствующих файлах
7. Задеплоил виртуальную машину с приложением с помощью Terraform и образа, созданного в ДЗ №5
8. Подменил для Git настоящий файл terraform.tfvars файлом terraform.tfvars.example c вымышленными значениями
9. Отформатировал все конфигурационные файлы, использовав команду terraform fmt


# HOMEWORK #7:

1. Создал ресурсы сети yandex_vpc_network и подсети yandex_vpc_network для конфигурирования будущих ВМ
2. Настроил неявную зависимость одного ресурса от другого
3. Пересоздал ресурсы с учетом неявной зависимости.
4. Создал два новых шаблона для Packer'а : db.json и app.json
5. С помощью шаблона db.json собрал образ VM, содержащий установленную MongoDB
6. С помощью шаблона app.json собрал образ VM с установленными Ruby
7. Разбил конфиг main.tf на 3 конфига: app.tf, db.tf и vpc.tf. Разбил остальную конфигурацию по файлам  и создал ресурсы (инстансы)
8. Видоизменил конфигурацию, разбив на модули db и app. Создал ресурсы
9. Добавил модули prod и stage. Создал ресурсы
10. Отформатировал все конфигурационные файлы, использовав команду terraform fmt
11. Подменил для Git настоящие файлы terraform.tfvars файлами terraform.tfvars.example c вымышленными значениями. Также подменил key.json


# HOMEWORK #8:

1. Установил и наcnроил клиент `Ansible` на рабочую машину
2. Поднял инфрастурктуру, описанную в окружении `stage` , и запустил виртуальные машины `app` и `db`
3. Создал inventory-файлы `ansible/inventory` и `ansible/inventory.yml`
4. Пропинговал инстансы с помощью модуля `ping`
5. Создал конфигурационный файл `ansible.cfg`
6. Изменил `ansible/inventory`, сформировав группы хостов `[app]` и `[db]`
7. Исследовал работу `Ansible` с модулями `command` и `shell`, `git`, `systemd` и `service`
8. Написал и выполнил плейбук `ansible/clone.yml`, протестировав его поведение после удаления директории с локальной копией репозитория приложения командой `ansible app -m command -a 'rm -rf ~/reddit'`

Когда мы в первый раз выполняем команду `ansible app -m command -a 'rm -rf ~/reddit'` , она удаляет локальную копию репозитория приложения.
Когда мы во второй раз выполняем эту же команду (после удаления директории), она уже заново локально сохранит копию приложения. При последующих запусках ничего не изменится, т.к. локальная копия репозитория уже существует.


# HOMEWORK #9:

###1. Использовал плейбуки, хендлеры и шаблоны для конфигурации окружения и деплоя тестового приложения.###
При этом применялись следующие варианты подходов:
#### один плейбук - одна пьеса ####
В данном подходе создан плейбук **reddit_app_one_play.yml** с одной пьесой, содержащей конфигурирование MongoDB, деплой приложения и конфигурирование приложения.
#### один плейбук - много пьес ####
В данном подходе создан плейбук **reddit_app_multiple_plays.yml** с тремя пьесами, содержащими, соответственно, конфигурирование MongoDB, деплой приложения и конфигурирование приложения.
#### много плейбуков ####
В данном подходе были созданы 3 плейбука - **db.yml**, **deploy.yml**  и **app.yml**, которые содержат, соответственно, пьесы по конфигурированию MongoDB, деплою приложения и конфигурированию приложения.


###2. Изменил provisioners образов Packer на Ansible-плейбуки.###
Создал два новых файла  - **packer_app.yml** и **packer_db.yml**. Первый устанавливает Ruby и Bundler, второй добавляет репозиторий MongoDB, устанавливает ее и включает сервис.


# HOMEWORK #10:

### 1. Перенес созданные плейбуки в раздельные роли. ###
Были созданы роль для приложения - **ansible/roles/app/** - и роль для базы данных - **ansible/roles/db/**.
Также надлежащим образом были сконфигурированы и структурированы необходимые составляющие каждой из ролей - плейбуки, таски, хэндлеры, шаблоны и т.д.  

### 2. Описал два окружения. ###
Создал директорию environments в директории ansible для определения настроек окружения.
В директории ansible/environments создал две директории для наших окружений - stage и prod.
Установил переменные по-умолчанию, установил переменные групп хостов и т.д.
Более ранние и не актуальные на данный момент наработки переместил в директории **ansible/playbooks**, **ansible/old**.

### 3. Использовал коммьюнити-роль nginx. ###
Использовал роль **jdauphant.nginx** и настроил обратное проксирование для приложения с помощью **nginx** - добавил в конфигурацию Terraform открытие 80 порта для инстанса приложения.

### 4. Использовал Ansible Vault для окружений. ###
Зашифровал пароли для пользователей **stage** и **prod** окружений и подготовил плейбук для создания пользователей.


# HOMEWORK #11:

### 1. Локальная разработка при помощи **Vagrant**, доработка ролей для провижининга в **Vagrant**. ###
1. Установил на **VritualBox**.
2. Установил **Vagrant**.
3. Создал **Vagrantfile**.
4. Создал (запустил) виртуальные машины. Были созданы два инстанса - **db** и **app** - без установленного ПО в виде M**ongoDB**, **Ruby**, **Git**  и пр.
5. Доработал роли **db** и **app**, добавив в них конфигурации из **packer_db.yml** и **packer_app.yml**. Подключил провиженеры. Логически разделил таски ролей по соответствующим файлам. Также выполнил ряд других действий по упорядочиванию и логическому устройству структуры ролей **db** и **app**. Проверил роли, работу приложения и конфигурацию.

### 2. Тестирование ролей при помощи **Molecule** и **Testinfra**. ###
1. Установил зависимости.
Установил виртуальное окружение venv для работы с **Python3**.
Далее установил все необходимые компоненты для тестирования: **Molecule**, **Ansible**, **Testinfra** и т.д. на локальную машину, используя **pip3**.
2. Добавил тесты, протестировал роль, сгенерировал плейбук **playbook.yml** (deprecated, теперь правильно **converge.yml**), применил конфигурацию и прогнал тесты.

### 3. Переключение сбора образов пакером на использование ролей. ###
1. Использовал роли **db** и **app** в плейбуках **packer_db.yml** и **packer_app.yml** и убедился, что все работает, как прежде (использовал теги для запуска только нужных тасков - теги указывал в шаблонах пакера, которые находятся в директории **packer** и называются **app.json** и **db.json**.).
